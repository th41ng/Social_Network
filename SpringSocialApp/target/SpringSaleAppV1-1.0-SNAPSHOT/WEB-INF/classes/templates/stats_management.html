<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Quản lý thống kê</title>
    <th:block th:replace="~{base :: bootstrap}"></th:block>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .btn-group > .btn.active { z-index: 1; }
        .chart-container { position: relative; margin: auto; height: 60vh; width: 80vw; margin-bottom: 2rem; }
    </style>
</head>
<body>
    <div th:replace="~{base :: header}"></div>

    <main class="container mt-4">
        <h2>Thống kê nền tảng hàng ngày</h2>
        <div class="chart-container mb-5">
            <canvas id="dailyStatsChart"></canvas>
        </div>

        <div class="table-responsive mb-5">
            <table class="table table-bordered table-hover">
                <thead class="table-light">
                    <tr>
                        <th>Thời điểm thống kê (ngày/tháng/năm giờ:phút:giây)</th>
                        <th>Tổng người dùng</th>
                        <th>Tổng bài viết</th>
                        <th>Người dùng mới hôm nay</th>
                        <th>Bài viết mới hôm nay</th>
                    </tr>
                </thead>
                <tbody>
                    <tr th:each="s : ${stats}">
                        <td th:text="${s.lastCalculatedAt != null ? #temporals.format(s.lastCalculatedAt, 'dd/MM/yyyy HH:mm:ss') : 'N/A'}"></td>
                        <td th:text="${s.totalUsers ?: '0'}"></td>
                        <td th:text="${s.totalPosts ?: '0'}"></td>
                        <td th:text="${s.newUsersRegisteredToday ?: '0'}"></td>
                        <td th:text="${s.newPostsCreatedToday ?: '0'}"></td>
                    </tr>
                    <tr th:if="${stats == null or #lists.isEmpty(stats)}">
                        <td colspan="5" class="text-center">Chưa có thống kê hàng ngày nào.</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <h2>Thống kê theo chu kỳ</h2>
        <div class="chart-container mb-3">
            <canvas id="periodicStatsChart"></canvas>
        </div>

        <div class="mb-3 btn-group" role="group" aria-label="Lọc thống kê chu kỳ">
            <button type="button" class="btn btn-primary active" onclick="filterPeriodicStats('all', this)">Tất cả</button>
            <button type="button" class="btn btn-secondary" onclick="filterPeriodicStats('monthly', this)">Theo Tháng</button>
            <button type="button" class="btn btn-secondary" onclick="filterPeriodicStats('quarterly', this)">Theo Quý</button>
            <button type="button" class="btn btn-secondary" onclick="filterPeriodicStats('yearly', this)">Theo Năm</button>
        </div>

        <div class="table-responsive">
            <table class="table table-bordered table-hover" id="periodicStatsTable">
                <thead class="table-light">
                    <tr>
                        <th>Chu kỳ</th>
                        <th>Loại</th>
                        <th>Người dùng mới</th>
                        <th>Bài viết mới</th>
                        <th>Thời điểm thống kê</th>
                    </tr>
                </thead>
                <tbody>
                    <tr th:each="p : ${periodicStats}" th:attr="data-period-type=${p.periodType.toString().toLowerCase()}">
                        <td>
                            <span th:if="${p.periodType == T(com.socialapp.pojo.PeriodicSummaryStats.PeriodType).monthly}"
                                  th:text="${p.summaryMonth + '/' + p.summaryYear}"></span>
                            <span th:if="${p.periodType == T(com.socialapp.pojo.PeriodicSummaryStats.PeriodType).quarterly}"
                                  th:text="${'Q' + p.summaryQuarter + '/' + p.summaryYear}"></span>
                            <span th:if="${p.periodType == T(com.socialapp.pojo.PeriodicSummaryStats.PeriodType).yearly}"
                                  th:text="${p.summaryYear}"></span>
                        </td>
                        <td th:text="${p.periodType}"></td>
                        <td th:text="${p.newUsersCount}"></td>
                        <td th:text="${p.newPostsCount}"></td>
                        <td th:text="${p.calculatedAt != null ? #temporals.format(p.calculatedAt, 'dd/MM/yyyy HH:mm:ss') : 'N/A'}"></td>
                    </tr>
                    <tr id="noPeriodicStatsRow" style="display: none;"> 
                        <td colspan="5" class="text-center"></td>
                    </tr>
                    <tr th:if="${periodicStats == null or #lists.isEmpty(periodicStats)}">
                         <td colspan="5" class="text-center">Chưa có thống kê theo chu kỳ nào.</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </main>

    <div th:replace="~{base :: footer}"></div>
    <script th:src="@{/js/main.js}"></script> 

    <script th:inline="javascript">
    /*<![CDATA[*/
    
    const dailyStatsData = /*[[${stats}]]*/ [];
    const periodicStatsData = /*[[${periodicStats}]]*/ [];
    let periodicChartInstance = null; 

    // --- Biểu đồ Thống kê Hàng ngày ---
    if (dailyStatsData && dailyStatsData.length > 0) {
        const dailyLabels = dailyStatsData.map(s => new Date(s.lastCalculatedAt).toLocaleDateString('vi-VN', { day: '2-digit', month: '2-digit' })).reverse();
        const newUsersToday = dailyStatsData.map(s => s.newUsersRegisteredToday || 0).reverse();
        const newPostsToday = dailyStatsData.map(s => s.newPostsCreatedToday || 0).reverse();
        const dailyCtx = document.getElementById('dailyStatsChart').getContext('2d');
        new Chart(dailyCtx, {
            type: 'line',
            data: { labels: dailyLabels, datasets: [
                { label: 'Người dùng mới', data: newUsersToday, borderColor: 'rgb(75, 192, 192)', tension: 0.1 },
                { label: 'Bài viết mới', data: newPostsToday, borderColor: 'rgb(255, 99, 132)', tension: 0.1 }
            ]},
            options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true } }, plugins: { title: { display: true, text: 'Thống kê mới hàng ngày' } } }
        });
    } else {
        const dailyChartCanvas = document.getElementById('dailyStatsChart');
        if (dailyChartCanvas) dailyChartCanvas.parentElement.innerHTML = '<p class="text-center">Không có dữ liệu thống kê hàng ngày.</p>';
    }

    // --- Biểu đồ Thống kê Chu kỳ ---
    function createOrUpdatePeriodicChart(filteredData) {
        const periodicLabels = filteredData.map(p => {
            if (p.periodType.toLowerCase() === 'monthly') return `${p.summaryMonth}/${p.summaryYear}`;
            if (p.periodType.toLowerCase() === 'quarterly') return `Q${p.summaryQuarter}/${p.summaryYear}`;
            if (p.periodType.toLowerCase() === 'yearly') return `${p.summaryYear}`;
            return 'N/A';
        });
        const newUsersPeriodic = filteredData.map(p => p.newUsersCount);
        const newPostsPeriodic = filteredData.map(p => p.newPostsCount);
        const periodicChartCanvas = document.getElementById('periodicStatsChart');
        const periodicCtx = periodicChartCanvas?.getContext('2d');
        const chartContainer = periodicChartCanvas?.parentElement;

        if (periodicChartInstance) periodicChartInstance.destroy();
        
        const oldNoDataMessage = chartContainer?.querySelector('p.text-center');
        if (oldNoDataMessage) oldNoDataMessage.remove();
        
        if (filteredData && filteredData.length > 0 && periodicCtx) {
            if (periodicChartCanvas) periodicChartCanvas.style.display = '';
            periodicChartInstance = new Chart(periodicCtx, {
                type: 'bar',
                data: { labels: periodicLabels, datasets: [
                    { label: 'Người dùng mới theo chu kỳ', data: newUsersPeriodic, backgroundColor: 'rgba(54, 162, 235, 0.5)', borderColor: 'rgb(54, 162, 235)', borderWidth: 1 },
                    { label: 'Bài viết mới theo chu kỳ', data: newPostsPeriodic, backgroundColor: 'rgba(255, 159, 64, 0.5)', borderColor: 'rgb(255, 159, 64)', borderWidth: 1 }
                ]},
                options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true } }, plugins: { title: { display: true, text: 'Thống kê mới theo chu kỳ' } } }
            });
        } else if (chartContainer) {
            if (periodicChartCanvas) periodicChartCanvas.style.display = 'none';
            const p = document.createElement('p');
            p.className = 'text-center';
            p.textContent = 'Không có dữ liệu thống kê chu kỳ cho bộ lọc này.';
            chartContainer.appendChild(p);
        }
    }

    if (periodicStatsData) createOrUpdatePeriodicChart(periodicStatsData); // Vẽ biểu đồ chu kỳ ban đầu

    // --- Lọc bảng và biểu đồ chu kỳ ---
    window.filterPeriodicStats = function(periodType, buttonElement) {
        document.querySelectorAll('.btn-group[aria-label="Lọc thống kê chu kỳ"] .btn').forEach(btn => {
            btn.classList.remove('btn-primary', 'active');
            btn.classList.add('btn-secondary');
        });
        buttonElement.classList.remove('btn-secondary');
        buttonElement.classList.add('btn-primary', 'active');

        const table = document.getElementById('periodicStatsTable');
        const tbody = table.getElementsByTagName('tbody')[0];
        const rows = tbody.getElementsByTagName('tr');
        const noPeriodicStatsRow = document.getElementById('noPeriodicStatsRow');
        const noDataRowOriginal = tbody.querySelector('tr[th\\:if="${periodicStats == null or #lists.isEmpty(periodicStats)}"]');
        let hasVisibleTableRows = false;
        
        for (let row of rows) {
            if (row.id === 'noPeriodicStatsRow' || (noDataRowOriginal && row === noDataRowOriginal)) continue;
            const rowPeriodType = row.getAttribute('data-period-type');
            const showRow = (periodType === 'all' || rowPeriodType === periodType);
            row.style.display = showRow ? '' : 'none';
            if (showRow) hasVisibleTableRows = true;
        }
        
        const filteredChartData = (periodType === 'all') ? (periodicStatsData || []) : (periodicStatsData || []).filter(p => p.periodType.toLowerCase() === periodType);
        createOrUpdatePeriodicChart(filteredChartData);

        if (noDataRowOriginal) noDataRowOriginal.style.display = 'none'; 
        if (noPeriodicStatsRow) {
            if (!hasVisibleTableRows) {
                noPeriodicStatsRow.style.display = '';
                noPeriodicStatsRow.getElementsByTagName('td')[0].textContent = `Không có thống kê ${periodType !== 'all' ? 'theo ' + periodType.replace('ly', '') : ''} nào.`;
            } else {
                noPeriodicStatsRow.style.display = 'none';
            }
        }
    }
    /*]]>*/
    </script>
</body>
</html>