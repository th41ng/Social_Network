<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
    <head>
        <title>Quản lý khảo sát</title>
    <th:block th:replace="~{base :: bootstrap}"></th:block>
<!--    <style>
        .pagination .page-item.active .page-link {
            background-color: #007bff;
            border-color: #007bff;
            color: white;
        }
        .pagination .page-link {
            color: #007bff;
        }
        .pagination .page-item.disabled .page-link {
            color: #6c757d;
        }
    </style>-->
</head>
<body>
    <div th:replace="~{base :: header}"></div>

    <main class="container mt-4">
        <h2>Quản lý khảo sát</h2>

        <div th:if="${successMessage}" class="alert alert-success alert-dismissible fade show" role="alert">
            <span th:text="${successMessage}"></span>
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
        <div th:if="${errorMessage}" class="alert alert-danger alert-dismissible fade show" role="alert">
            <span th:text="${errorMessage}"></span>
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>


        <a th:href="@{/surveys/add}" class="btn btn-info mb-3">Thêm khảo sát</a>

        <form class="row g-3 mb-3" method="get" th:action="@{/surveys}">
            <div class="col-md-4">
                <input type="text" class="form-control" name="kw" placeholder="Tìm theo tiêu đề..."
                       th:value="${params != null ? params['kw'] : ''}">
            </div>
            <div class="col-md-3">
                <input type="date" class="form-control" name="fromDate" th:value="${params != null ? params['fromDate'] : ''}">
            </div>
            <div class="col-md-3">
                <input type="date" class="form-control" name="toDate" th:value="${params != null ? params['toDate'] : ''}">
            </div>
            <input type="hidden" name="orderBy" th:value="${params !=null ? params['orderBy'] : ''}" />

            <div class="col-md-2">
                <button type="submit" class="btn btn-primary w-100">Tìm kiếm</button>
            </div>
        </form>

        <div class="table-responsive">
            <table class="table table-bordered table-hover">
                <thead class="table-light">
                    <tr>
                        <th>ID</th>
                        <th>Tiêu đề</th>
                        <th>Mô tả</th>
                        <th>Ngày tạo</th>
                        <th>Trạng thái</th>
                        <th>Hành động</th>
                    </tr>
                </thead>
                <tbody>
                    <tr th:each="s : ${surveys}">
                        <td th:text="${s.surveyId}"></td>
                        <td th:text="${s.title}"></td>
                        <td th:text="${s.description}"></td>
                        <td th:text="${s.createdAt != null ? #dates.format(s.createdAt, 'dd/MM/yyyy HH:mm') : ''}"></td>
                        <td>
                            <span th:if="${s.getIsActive()}" class="badge bg-success">Hoạt động</span>
                            <span th:unless="${s.getIsActive()}" class="badge bg-danger">Không hoạt động</span>
                        </td>
                        <td>
                            <a th:href="@{'/surveys/' + ${s.surveyId}}" class="btn btn-success btn-sm mb-1" title="Chỉnh sửa">&#128296;️</a>
                            <a th:href="@{'/questions/' + ${s.surveyId}}" class="btn btn-info btn-sm mb-1" title="Quản lý Câu hỏi">Câu hỏi</a>
                            <a th:href="@{'/responses/survey/' + ${s.surveyId}}" class="btn btn-primary btn-sm mb-1" title="Xem tất cả Phản hồi của Khảo sát này">Phản hồi KS</a>
                            <form th:action="@{/surveys/toggle-active/{id}(id=${s.surveyId})}" method="post" style="display: inline-block; margin-bottom: 0.25rem;">
                                <button type="submit"
                                        th:class="${s.getIsActive() ? 'btn btn-warning btn-sm' : 'btn btn-success btn-sm'}"
                                        th:title="${s.getIsActive() ? 'Vô hiệu hóa' : 'Kích hoạt'}">
                                    <span th:text="${s.getIsActive() ? 'Tắt' : 'Bật'}"></span>
                                </button>
                            </form>
                            <button type="button" class="btn btn-danger btn-sm mb-1" title="Xoá"
                                    th:onclick="'deleteSurvey(\'' + @{/api/surveys/delete/{id}(id=${s.surveyId})} + '\')'">
                                Xoá
                            </button>
                        </td>
                    </tr>
                    <tr th:if="${surveys == null or #lists.isEmpty(surveys)}">
                        <td colspan="6" class="text-center">Không có khảo sát nào.</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <nav aria-label="Page navigation" th:if="${totalPages > 0}">
            <ul class="pagination justify-content-center">
                <li class="page-item" th:classappend="${currentPage == 1 ? 'disabled' : ''}">
                    <a class="page-link" 
                       th:href="@{/surveys(page=${currentPage - 1}, kw=${params['kw']}, fromDate=${params['fromDate']}, toDate=${params['toDate']}, orderBy=${params['orderBy']})}">Trước</a>
                </li>

                <li class="page-item" th:each="i : ${#numbers.sequence(1, totalPages)}"
                    th:classappend="${i == currentPage ? 'active' : ''}">
                    <a class="page-link" 
                       th:href="@{/surveys(page=${i}, kw=${params['kw']}, fromDate=${params['fromDate']}, toDate=${params['toDate']}, orderBy=${params['orderBy']})}"
                       th:text="${i}"></a>
                </li>

                <li class="page-item" th:classappend="${currentPage == totalPages ? 'disabled' : ''}">
                    <a class="page-link" 
                       th:href="@{/surveys(page=${currentPage + 1}, kw=${params['kw']}, fromDate=${params['fromDate']}, toDate=${params['toDate']}, orderBy=${params['orderBy']})}">Sau</a>
                </li>
            </ul>
        </nav>
    </main>

    <div th:replace="~{base :: footer}"></div>
    <script th:src="@{/js/main.js}"></script>

</body>
</html>